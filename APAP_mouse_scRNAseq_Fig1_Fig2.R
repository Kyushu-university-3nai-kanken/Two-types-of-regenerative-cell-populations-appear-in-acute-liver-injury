# APAP mouse sc-RNAseq

library(Seurat)
library(patchwork)
library(knitr)
library(rmarkdown)
library(gt)
library(ggrepel)
library(org.Mm.eg.db)
library(clusterProfiler)
library(pathview)
library(AnnotationDbi)
library(GO.db)
library(DOSE)
library(tidyverse)
library(ComplexHeatmap)
library(future)
library(CellChat)
library(msigdbr)
library(ggsignif)
library(ggridges)


# read file
hep <- readRDS("hep_m1_ver3")

all_gene <- rownames(hep@assays$RNA@data)
anno_df <- AnnotationDbi::select(x = org.Mm.eg.db,keys = all_gene,keytype = "SYMBOL",columns = c("SYMBOL", "ENTREZID", "GO","PATH"))
go_df <- AnnotationDbi::select(GO.db,keys = anno_df$GO,columns = c("ONTOLOGY","TERM"),keytype = "GOID")
m <- match(anno_df$GO,go_df$GOID)
anno_df$GO_Term <- go_df$TERM[m]
remove(go_df,m)

DefaultAssay(hep) <- "RNA"

 # cellcycle score
s.gene <- cc.genes.updated.2019$s.genes
s.gene <- str_to_title(s.gene)
s.gene <- s.gene[s.gene %in% all_gene]
g2m.gene <- cc.genes.updated.2019$g2m.genes
g2m.gene <- str_to_title(g2m.gene)
g2m.gene <- g2m.gene[g2m.gene %in% all_gene]

hep <- CellCycleScoring(hep,s.features = s.gene,g2m.features = g2m.gene,set.ident = F)
hep@meta.data$Phase <- factor(hep@meta.data$Phase,levels = c("G1","S","G2M"))


# Fig.1A
p1 <- DimPlot(hep,group.by = "seurat_clusters",label = T,label.size = 6)+NoLegend()+
  ggtitle("Clusters")
p2 <- DimPlot(hep,group.by = "Time")
p1+p2


# Fig.1B
p_cellcycle <- ggplot(hep@meta.data,aes(x=Time,fill=Phase))+
  geom_bar(position = "fill")+
  scale_y_continuous(labels = scales::percent,expand = expansion(mult = c(0, .1)))+
  ylab("Percentage(%)")+
  xlab(label = "Time(h)")+
  scale_x_discrete(labels=c("0","48","72"))
p1 <- p_cellcycle+theme_classic()
p1


# Fig.1C
ki67_percent_df <- data.frame(cls=as.character(0:13))
ki67_percent_df$percent <- 0

cal_df <-as.data.frame(hep@meta.data$seurat_clusters)
colnames(cal_df)[1] <- "cls"
a <- which(rownames(hep@assays$RNA@data)=="Mki67")
m <- hep@assays$RNA@data[a,]>0
cal_df$Mki67_none <- "none"
cal_df$Mki67_none[m] <- "Mki_67"

count_caldf <-as.data.frame( table((interaction(cal_df$cls,cal_df$Mki67_none))))

ki67_percent_df$Mki67_count <- count_caldf[1:14,2]
ki67_percent_df$total_cell <- count_caldf[1:14,2]+count_caldf[15:28,2]
ki67_percent_df$percent <- ki67_percent_df$Mki67_count/ki67_percent_df$total_cell*100
ki67_percent_df$cls <- factor(ki67_percent_df$cls,levels = 0:13)

p_mki67_percent <- ggplot(ki67_percent_df,aes(x=cls,y=percent,fill=cls))+
  geom_col()+
  ylab("Percentage(%)")+
  xlab("Cluster")+
  scale_y_continuous(expand = c(0,0),limits = c(0,18))

p1 <- p_mki67_percent+theme_classic()+theme(legend.position = "none")
p1


# Fig.1D
remove(list = ls()[!(ls() %in% c("anno_df","hep","all_gene"))])

kegg_Glycolysis_mmu00010 <- c("103988","106557","110695","11522","11529","11532","115487111","11669","11670","11671","11674","11676","12183","13382","13806","13807","13808","14120","14121","14377","14378","14433","14447","14751","15275","15277","16828","16832","16833","17330","18534","18597","18598","18641","18642","18648","18655","18663","18746","18770","212032","216019","21991","226265","230163","235339","26876","319625","353204","433182","56012","56421","56752","58810","60525","621603","66681","67689","68263","68401","68738","72141","72157","72535","73458","74551","79459")

kegg_O2_phosphorylation_mmu00190 <-c("100041273","100042503","104130","108664","110323","110935","114143","11944","11945","11946","11947","11949","11950","11951","11957","11958","11964","11966","11972","11973","11974","11975","11984","12856","12857","12858","12859","12861","12862","12864","12865","12866","12867","12868","12869","13063","13067","140494","17705","17706","17708","17709","17710","17711","17716","17717","17718","17719","17720","17721","17722","17991","17992","17993","17995","192113","20463","21871","22272","22273","225887","226139","226646","227197","228033","230075","242341","27060","27425","28080","333182","338375","407785","407790","54405","54411","57423","595136","66043","66046","66052","66091","66108","66142","66144","66152","66218","66237","66290","66335","66377","66414","66416","66445","66495","66576","66594","66694","66916","66925","66945","67003","67126","67130","67184","67264","67273","67530","67680","67895","67942","68194","68197","68198","68202","68342","68349","68375","68775","69802","69875","70316","70383","71679","72900","73834","74776","74915","75406","75483","76252","76429","78174","78330","84682")

kegg_Fatty_acid_biosynthesis_mmu00061<- c("100705","107476","109729085","14081","14104","14979","216739","223722","234309","257633","26922","328845","433256","50790","71147","74205","78625","94180","99035")

kegg_Fatty_acid_degradation_mmu00071 <- c("100040843","110446","110460","110695","11363","11364","11370","113868","11409","11430","11522","11529","11532","11669","11671","12894","12895","12896","13117","13118","13119","13177","14081","15107","216739","224530","230639","231086","235674","23986","26876","270076","277753","328845","433256","435802","50790","52538","56752","666168","66885","69123","71519","72535","74147","74205","78070","78625","80911","93747","94180","97212")

kegg_Alanine_aspartate_glutamate_metabolism_mmu00250 <-
  c("14718","76615","14719","14204","100470","100328588","73988","70503","66514","27053","52633","108682","76282","11611","268782","11898","109900","11565","11566","11564","269642","108653","194237","53320","11484","14415","14417","268860","214579","14661","212647","14645","69719","216456","14660","227231","14583","14584","231327")

kegg_TCA_cycle_mmu00020 <- c("104112","11428","11429","12974","13382","14194","15926","15929","170718","17448","17449","18293","18534","18563","18597","18598","20916","20917","235339","239017","243996","269951","56451","66052","66925","66945","67680","67834","68263","71832","74551","78920")

kegg_nucleotido_biosynthesis <- c("108147","11564","14450","231327","237823","67054","102216272","11564","11565","11566","11636","11637","11639","171567","18102","18103","229949","54369","56248","56520","633979","68870","78801","79059","14923","171567","18102","18103","229363","23917","23918","54369","56520","633979","79059","171567","18102","18103","20133","20135","382985","54369","56520","633979","79059","22247","56749","69719","110074","171567","18102","18103","20133","20135","21915","22171","382985","54369","56520","633979","79059")

kegg_nucleotido_biosynthesis <- unique(kegg_nucleotido_biosynthesis)

kegg_gene_list <- list(kegg_Glycolysis_mmu00010,
                       kegg_O2_phosphorylation_mmu00190,
                       kegg_Fatty_acid_biosynthesis_mmu00061,
                       kegg_Fatty_acid_degradation_mmu00071,
                       kegg_TCA_cycle_mmu00020,
                       kegg_nucleotido_biosynthesis,
                       kegg_Alanine_aspartate_glutamate_metabolism_mmu00250)

kegg_list_name <- c("Glycolysis_mmu00010",
                    "O2_mmu00190",
                    "Fat_biosynthesis_mmu00061",
                    "Fat_degradation_mmu00071",
                    "TCA_mmu00020",
                    "nucleotido",
                    "Alanine_mmu00250")

names(kegg_gene_list) <- kegg_list_name

for (i in 1:7) {
  gene_i <- kegg_gene_list[[i]]
  m <- match(gene_i,anno_df$ENTREZID)
  m <- m[!is.na(m)]
  gene_i <- anno_df$SYMBOL[m]
  kegg_gene_list[[i]] <- gene_i
  names(kegg_gene_list[i]) <- kegg_list_name[i]
}

hep48 <- subset(hep,Time=="48h")
hep48 <- subset(hep,seurat_clusters %in% c(0,1,7,8,10,12))
hep48 <- ScaleData(hep48,features = all_gene)

metabolism_df_48_original <- matrix(ncol = 7)
colnames(metabolism_df_48_original) <- c("0","1","7","8","10","12","split")
metabolism_df_48_original <- as.data.frame(metabolism_df_48_original)

for (i in 1:7) {
  gene <- kegg_gene_list[[i]]
  a <- AverageExpression(hep48,assays = "RNA",slot ="scale.data",features = gene )
  a <- a$RNA
  a <- as.data.frame(a)
  a$split <- names(kegg_gene_list[i])
  metabolism_df_48_original <- rbind(metabolism_df_48_original,a)
}

metabolism_df_48_original <- metabolism_df_48_original[complete.cases(metabolism_df_48_original),]

split_original <- metabolism_df_48_original$split
metabolism_df_48_original$split <- NULL


p <- ComplexHeatmap::Heatmap(metabolism_df_48_original,cluster_rows = T,
                             show_row_names = F,cluster_columns = T,
                             row_split = factor(x = split_original),
                             row_title_side = "left",
                             row_title_rot = 0,row_title_gp = gpar(fontsize=3),
                             row_dend_side = "right",column_dend_height = unit(0.3,"cm"),
                             row_dend_width = unit(0.3,"cm"),
                             column_title = "48h clusters",
                             column_title_gp = gpar(fontsize=8),
                             column_names_gp = gpar(fontsize=8),
                             heatmap_legend_param =list(title="Scale",
                                                        grid_width=unit(0.3,"cm"),
                                                        title_gp=gpar(fontsize=8),
                                                        labels_gp=gpar(fontsize=8)),
                             width = unit(2,"cm"))
p


# Fig.S1A
remove(list = ls()[!(ls() %in% c("anno_df","hep","all_gene"))])
p1 <- VlnPlot(hep,"Alb",pt.size = 0)+NoLegend()
p2 <- VlnPlot(hep,"Ass1",pt.size = 0)+NoLegend()
p3 <- VlnPlot(hep,"Cyp2e1",pt.size = 0)+NoLegend()
p4 <- VlnPlot(hep,"Krt18",pt.size = 0)+NoLegend()
p1+p2+p3+p4


# Fig.S1B
remove(list = ls()[!(ls() %in% c("anno_df","hep","all_gene"))])
p1 <- VlnPlot(hep,"Krt19")+NoLegend()
p2 <- VlnPlot(hep,"Pecam1")+NoLegend()
p3 <- VlnPlot(hep,"Des")+NoLegend()
p4 <- VlnPlot(hep,"Adgre1")+NoLegend()
p1+p2+p3+p4


# Fig.S1C
average_df <- AverageExpression(hep,features = c("Mki67","Pcna","Tyms"),
                                group.by = "Time",slot = "data")
average_df <- average_df$RNA
relative_df <- data.frame(Time=colnames(average_df))
rownames(relative_df) <- NULL
relative_df$Mki67 <- average_df[1,]/average_df[1,1]
relative_df$Pcna <- average_df[2,]/average_df[2,1]
relative_df$Tyms <- average_df[3,]/average_df[3,1]
 # write.csv(relative_df,file = "Mki67_Pcna_Tyms_72h.csv")


# Fig.2A, Fig.2C, Fig.2E
remove(list = ls()[!(ls() %in% c("anno_df","hep","all_gene"))])
p1 <- VlnPlot(hep,"Malat1",pt.size = 0)+NoLegend()
p2 <- VlnPlot(hep,"Neat1",pt.size = 0)+NoLegend()
p3 <- VlnPlot(hep,"Trp53inp1",pt.size = 0)+NoLegend()
p4 <- VlnPlot(hep,"nFeature_RNA",pt.size = 0)+NoLegend()+
  ggtitle("Number of expressed genes")
p5 <- VlnPlot(hep,"Jun",pt.size = 0)+NoLegend()
p6 <- VlnPlot(hep,"Egfr",pt.size = 0)+NoLegend()
p7 <- VlnPlot(hep,"Pik3r1",pt.size = 0)+NoLegend()
p1+p2+p3
p4
p5+p6+p7


# Fig.2B
remove(list = ls()[!(ls() %in% c("anno_df","hep","all_gene"))])

deg_7 <- FindMarkers(hep,ident.1 = 7)
deg_7 <- deg_7[deg_7$p_val_adj<1,]
deg_7 <- deg_7[deg_7$avg_log2FC>0,]

stem_gene <- c("110157","11477","11479","11480","11481","11651","11652","11789","11906","12005","12006","12151","12159","12166","12167","12168","12387","13395","13542","13543","13544","13590","13984","13990","14173","14182","14183","14184","14186","14362","14365","14366","14367","14368","14369","14370","14371","14784","15110","15209","15379","15394","15407","15429","15461","15901","15902","15903","15904","16000","16001","16195","16323","16324","16325","16326","16392","16451","16452","16453","16468","16600","16653","16873","16878","16880","17125","17126","17127","17128","17129","17268","17869","17877","18014","18119","18176","18423","18508","18706","18707","18708","18709","18710","18999","19094","19712","20482","20674","20848","20890","21386","21414","21423","216795","22408","22409","22410","22411","22412","22413","22414","22415","22416","22417","22418","22419","22420","22421","22422","22423","22658","22773","23797","23805","244349","26380","26395","26396","26413","26415","26416","26417","269275","29857","320202","51869","55994","56637","57265","69587","69837","71041","71950","74769","75590","76073","84505","93735","93897")
m <- match(stem_gene,anno_df$ENTREZID)
stem_gene <- anno_df$SYMBOL[m]
stem_gene <- stem_gene[stem_gene %in% all_gene]

　# Calculate the gene expression positivity rate for each cluster.
stem_pct_df <- matrix(nrow = length(stem_gene),ncol = 14)
stem_pct_df <- as.data.frame(stem_pct_df)
rownames(stem_pct_df) <- stem_gene
colnames(stem_pct_df) <- 0:13

for (i in 0:13) {
  cls <- as.character(i)
  a <- FoldChange(hep,ident.1 = cls,features = stem_gene) 
  stem_pct_df[,i+1] <- a$pct.1
}
remove(a)
stem_pct_df$MAX <- apply(stem_pct_df,MARGIN = 1,FUN = max)
stem_gene_new <- rownames(stem_pct_df[stem_pct_df$MAX>=0.1,])

stem_deg_cls7 <- deg_7[rownames(deg_7) %in% stem_gene_new,]


stem_gene_df <- AverageExpression(hep,features = stem_gene_new,assays = "RNA",
                                  slot = "scale.data")
stem_gene_df <- as.matrix(stem_gene_df$RNA)

gene_stem_7 <- rownames(stem_deg_cls7)

p <- ComplexHeatmap::Heatmap(stem_gene_df,
                             row_names_gp = gpar(fontsize=6,
                                                 col = ifelse(rownames(stem_gene_df) %in% gene_stem_7, "#E63946", "black")),
                             column_dend_height = unit(0.3,"cm"),
                             row_dend_width = unit(0.3,"cm"),
                             column_names_gp = gpar(fontsize=8),
                             heatmap_legend_param =list(title="Scale",
                                                        grid_width=unit(0.2,"cm"),
                                                        title_gp=gpar(fontsize=6),
                                                        labels_gp=gpar(fontsize=6)),
                             width = unit(3,"cm"),height = unit(6,"cm"))
p


# Fig.2D
remove(list = ls()[!(ls() %in% c("anno_df","hep","all_gene"))])

signal_gene_list <- list()
MAPK_gene <- c("12286","12287","12288","12289","12290","54652","12291","58226","239556","12292","12293","56808","12294","319734","12295","12296","12297","12298","12299","12300","54376","54377","140723","54378","81904","81905","18747","18749","18750","18751","18752","14673","14701","100503710","19057","19055","19056","19058","19059","19417","19418","19419","19395","240168","233046","76089","18015","218397","114713","109905","215449","13645","21802","13874","11839","14164","14173","14174","14175","14176","14178","14179","14180","14165","80903","14171","14172","80857","67112","14177","14170","56636","64654","18048","18049","12064","18205","78405","16334","16333","16000","16002","18590","18591","54635","71785","12977","17311","14256","22339","22340","18654","22341","14205","15234","11600","11601","11602","13636","13637","13639","13640","13638","14573","18188","11876","19197","13649","13866","13867","13869","14182","14183","14184","14186","18053","18211","18212","16337","16001","18595","18596","12978","16590","14255","14254","14257","16542","17295","21687","13836","19713","14784","20662","20663","15461","16653","18176","20130","66922","17532","11836","109880","110157","26395","26396","56692","26413","26417","17346","17347","110651","20111","20112","67071","11911","13712","13714","17869","20807","14281","17762","16765","329502","18783","211429","232889","78390","271844","21926","16175","16176","21803","21808","21809","21937","16177","16180","21812","21813","14103","14102","12475","19353","19354","170758","12540","71609","12367","22030","13163","17874","16179","266632","22034","13197","17873","23882","66513","68652","26940","225028","26921","26411","18479","224105","58231","56274","26412","26410","26401","26403","26405","26406","338372","269881","234878","26404","71751","65964","53608","26408","26409","26407","330177","216965","381921","26398","26400","26397","26399","19099","60597","30957","192176","286940","68794","12928","12929","109689","216869","26419","26420","26414","26416","19094","29857","26415","17165","17164","102626","73086","56613","12531","18018","18021","16476","16478","11909","22059","13198","17187","17260","15507","11651","11652","23797","19042","19279","19259","320139","19252","319520","235584","18218","240672","13537","70686","67603","75590","63953","72349","19060","19043","15481","15482","193740","15511","14013","23938","23939","15370","53859","12675","16150","16151","18099","18033","18034","19697","19698")
m <- match(MAPK_gene,anno_df$ENTREZID)
MAPK_gene <- anno_df$SYMBOL[m]
MAPK_gene <- MAPK_gene[!is.na(MAPK_gene)]
signal_gene_list[[1]] <- MAPK_gene
names(signal_gene_list)[1] <- "MAPK"

ErbB_gene <- c("13645","21802","11839","13649","13866","18803","234779","108058","12325","12323","12322","18750","18751","18752","12402","208650","20850","20851","20779","14083","12928","12929","11350","11352","17973","17974","18479","224105","18481","70584","241656","214230","26398","26400","26419","26420","26414","16476","13712","12223","15200","13874","13867","211323","100042150","13869","20416","216148","20418","271849","14784","20662","20663","15461","16653","18176","11836","109880","110157","26395","26396","26413","26417","17869","14388","18183","83961","18706","18707","74769","18709","18708","18710","11651","11652","23797","56717","58988","72508","13685","12015","56637","12576","12575")
m <- match(ErbB_gene,anno_df$ENTREZID)
ErbB_gene <- anno_df$SYMBOL[m]
ErbB_gene <- ErbB_gene[!is.na(ErbB_gene)]
signal_gene_list[[2]] <- ErbB_gene
names(signal_gene_list)[2] <- "ErbB"

Notch_gene <- c("13388","13389","54485","16449","16450","16848","17305","19719","18128","18129","18131","18132","19664","19668","15205","15208","56198","15213","15214","19208","67122","13544","13542","13543","18222","18223","16396","14357","207521","209200","74198","80904","11491","19164","19165","66340","59287","226548","68318","208117","103806","433586","270118","12914","328572","14534","18519","66354","13016","13017","102638837","114606","21885","21886","21887","21888","20602","66935","56381","15182","433759","20238","52335")
m <- match(Notch_gene,anno_df$ENTREZID)
Notch_gene <- anno_df$SYMBOL[m]
Notch_gene <- Notch_gene[!is.na(Notch_gene)]
signal_gene_list[[3]] <- Notch_gene
names(signal_gene_list)[3] <- "Notch"

Ras_gene <- c("13645","21802","14164","14173","14174","14175","14176","14178","14179","14180","14165","80903","14171","14172","80857","67112","14177","14170","56636","64654","18048","18049","12064","18205","78405","16334","16333","16000","16002","18590","18591","54635","71785","12977","17311","14256","22339","22340","18654","22341","14205","15234","11600","11601","11602","13636","13637","13639","13640","13638","13649","14182","14183","14184","14186","18053","18211","18212","16337","16001","18595","18596","12978","16590","14255","14254","14257","16542","17295","21687","13836","14784","14388","14389","20416","216148","20418","271849","19247","20662","20663","18803","234779","19419","19395","240168","233046","22637","16797","15566","14688","14693","14695","14696","14697","14702","14704","14706","14707","14708","14709","14700","66066","14701","100503710","64337","14699","14710","18747","18749","19417","19418","14810","14811","14812","12313","80796","12315","12314","70405","494124","75600","15461","16653","18176","17532","20130","66922","18015","218397","114713","19414","54153","240057","19415","226525","320484","56289","54354","58231","21844","19353","19354","170758","18479","224105","18481","70584","241656","214230","11848","67653","18706","18707","74769","18709","18708","18710","11651","11652","23797","16151","12675","16150","18033","19697","12015","12048","54601","14103","56784","241694","228850","19730","19731","19732","56044","64143","18806","18805","66482","56480","19696","26419","26420","26414","19765","12540","17356","56392","110157","26395","26396","26413","26417","85031","26971","18778","18781","18784","18782","26970","66350","69836","26565","18780","237625","329502","18783","211429","232889","78390","271844","53357","225845","13712","23871","23872","72399","16706","333050","217944","109905","215449","74055","18750","18751","18752","225870","11350","11352","271457","19344","19345","11845")
m <- match(Ras_gene,anno_df$ENTREZID)
Ras_gene <- anno_df$SYMBOL[m]
Ras_gene <- Ras_gene[!is.na(Ras_gene)]
signal_gene_list[[4]] <- Ras_gene
names(signal_gene_list)[4] <- "Ras"

Rap1_gene <- c("109905","215449","17532","217944","238130","14810","14811","14812","12313","80796","12315","12314","70405","494124","75600","14062","14065","18441","14293","14745","53978","65086","78134","381810","11540","11541","14683","432530","210044","104111","104110","224129","11512","11513","11514","11515","223864","56508","14682","18795","18797","18798","18796","240168","19395","13645","14164","14173","14174","14175","14176","14178","14179","14180","14165","80903","14171","14172","80857","67112","14177","14170","56636","64654","18048","18049","16334","16333","16000","18590","18591","54635","71785","12977","17311","22339","22340","18654","22341","14205","15234","11600","11601","11602","13636","13637","13639","13640","13638","13649","14182","14183","14184","14186","18053","16337","16001","18595","18596","12978","16590","14254","14257","16542","17295","21687","13836","12928","12929","107746","12927","12550","12387","14924","50791","99470","76089","192786","16797","23880","16822","78473","18803","18750","18751","18752","18760","75292","101540","13489","12801","14677","14679","14678","14681","110351","217692","20469","244668","74206","15901","21825","19730","56044","64143","19353","19354","170758","54519","21894","70549","16399","16416","18643","18645","75477","382562","22323","13800","14026","11465","11461","106952","11848","67653","20779","227377","12540","22324","22325","57257","21844","93742","56513","58220","93737","18762","18759","17356","12388","79264","51791","54354","16408","16409","16414","16415","16412","109880","110157","26395","26396","26413","26417","26397","26399","26416","19094","29857","26415","18706","18707","74769","18709","18708","18710","11651","11652","23797","74055","15461","16653","18176","20130")
m <- match(Rap1_gene,anno_df$ENTREZID)
Rap1_gene <- anno_df$SYMBOL[m]
Rap1_gene <- Rap1_gene[!is.na(Rap1_gene)]
signal_gene_list[[5]] <- Rap1_gene
names(signal_gene_list)[5] <- "Rap1"

Wnt_gene <- c("53627","22408","22413","22414","22415","22416","22417","22418","22419","22420","22421","22422","20890","22423","216795","22412","22410","22409","22411","93735","12622","77583","24117","74499","13380","56811","234130","20317","20377","20319","20378","20379","54612","192199","239405","72780","228770","107515","14160","329252","207742","407821","14362","14369","57265","14365","14366","14367","14370","14368","93897","14371","16973","16974","68010","494504","27373","68339","13544","13542","13543","14296","27412","212398","12995","13000","13001","93960","72293","319478","75826","114671","231201","408192","408191","56637","12387","12005","12006","11789","23805","93687","21414","21415","21416","16842","226154","67087","73739","67772","328949","219158","93759","20671","13016","13017","102638837","114606","21885","21886","21887","21888","18163","12914","328572","56505","17128","17127","26409","18099","17869","16476","14283","12443","12444","12445","22402","19015","17393","19164","18747","18749","22059","20437","20438","12301","21402","21372","81004","103583","12234","26965","56438","14735","26563","26564","20187","93840","229658","243548","106042","381104","54630","16348","208846","76441","11848","67653","19878","19353","19354","170758","26419","26420","26414","18795","18797","18798","18796","108058","12325","12323","12322","19057","19055","19056","19058","19059","18750","18751","18752","18018","18019","18021","73181")
m <- match(Wnt_gene,anno_df$ENTREZID)
Wnt_gene <- anno_df$SYMBOL[m]
Wnt_gene <- Wnt_gene[!is.na(Wnt_gene)]
signal_gene_list[[6]] <- Wnt_gene
names(signal_gene_list)[6] <- "Wnt"

Hedgehog_gene <- c("19206","19207","319757","240888","18747","18749","93687","103236","214897","70425","104318","27373","56637","14632","14633","14634","24069","16576","15245","12443","12444","12043","26965","103583","12234","226861","74770","20423","16147","13363","68897","56788","117606","57810","14451","14725","233812","269878","17237","66313","75788","110355","320129","59056","68525","230500","74239","109689","216869","16568","26554","20747","76857","100042761","100043188","399674","399675","399676")
m <- match(Hedgehog_gene,anno_df$ENTREZID)
Hedgehog_gene <- anno_df$SYMBOL[m]
Hedgehog_gene <- Hedgehog_gene[!is.na(Hedgehog_gene)]
signal_gene_list[[7]] <- Hedgehog_gene
names(signal_gene_list)[7] <- "Hedgehog"

TGFb_gene <- c("12667","18121","17965","23892","23893","21825","13179","14264","13590","320202","14313","12156","12159","12161","16324","22041","71775","12160","12162","12164","12163","14563","242316","238057","11705","15978","21926","207596","14118","268977","21803","21808","21809","16323","16325","16326","18119","12166","12167","11477","12168","69585","18007","15216","50765","22042","244058","68799","110542","21812","21813","13732","434215","224109","11479","11481","11480","269275","209268","68010","17125","17129","55994","17126","17127","17128","17130","17131","66313","75788","218441","230597","56438","26965","21402","26413","26417","11848","67653","19877","51792","73699","19052","19053","58988","72508","66438","84506","15901","15902","15903","15904","19650","104394","13559","21781","12914","328572","20683","20482","20481","20466","15182","433759","20185","21815","228839","17869","12579","18741")
m <- match(TGFb_gene,anno_df$ENTREZID)
TGFb_gene <- anno_df$SYMBOL[m]
TGFb_gene <- TGFb_gene[!is.na(TGFb_gene)]
signal_gene_list[[8]] <- TGFb_gene
names(signal_gene_list)[8] <- "TGFb"

Hippo_gene <- c("241324","170788","93742","56513","58220","93737","18762","18759","12695","56217","27494","22601","97064","12550","16475","101543","29806","18016","211652","319710","64010","56274","73246","56289","19052","19053","51792","73699","52432","72930","269643","71978","16798","50523","232157","68473","19045","19046","19047","434233","209456","16897","217325","105782","13383","23859","53310","13385","71228","104318","27373","103583","12234","22062","170770","21676","21679","21678","21677","14219","14633","11839","11799","11576","16414","16415","14164","21803","21808","21809","21812","21813","17131","17126","17127","17128","18787","12156","12159","12160","12161","12162","12164","12163","14563","242316","238057","11705","12166","12167","12168","17125","15901","15902","22408","22413","22414","22415","22416","22417","22418","22419","22420","22421","22422","20890","22423","216795","22412","22410","22409","22411","93735","14362","14369","57265","14365","14366","14367","14370","14368","93897","14371","13544","13542","13543","22631","54401","22630","22627","22629","22628","56637","12387","11789","23805","12005","12006","93960","72293","21414","21415","21416","16842","17869","12443","12444","12445","20674","20583","11797","11796","11465","11461","12386","216033","12385")
m <- match(Hippo_gene,anno_df$ENTREZID)
Hippo_gene <- anno_df$SYMBOL[m]
Hippo_gene <- Hippo_gene[!is.na(Hippo_gene)]
signal_gene_list[[9]] <- Hippo_gene
names(signal_gene_list)[9] <- "Hippo"

VEGF_gene <- c("22339","16542","27371","18803","234779","18750","18751","18752","56632","20698","15461","16653","18176","110157","26395","26396","26413","26417","329502","18783","211429","232889","78390","271844","19057","19055","19056","19058","19059","18019","19225","14083","216148","19303","12540","26416","19094","29857","26415","17164","102626","15507","20779","18706","18707","74769","18709","18708","18710","19353","19354","170758","11651","11652","23797","18127","12371","12015")
m <- match(VEGF_gene,anno_df$ENTREZID)
VEGF_gene <- anno_df$SYMBOL[m]
VEGF_gene <- VEGF_gene[!is.na(VEGF_gene)]
signal_gene_list[[10]] <- VEGF_gene
names(signal_gene_list)[10] <- "VEGF"

JAK_STAT_gene <- c("16183","16189","16196","16198","16168","60505","53603","16184","16185","16186","16190","16197","16199","16169","60504","57914","16187","16191","12981","16188","16192","12982","12984","12983","16193","16156","16163","246779","76399","18413","16878","12803","13019","244218","56708","16194","16195","16157","16158","100042555","16164","16165","50931","218624","18414","16880","12804","16153","329244","50929","116849","58181","93672","16154","16155","237313","213208","230828","237310","16159","16160","83430","16161","16162","209590","13856","14599","19109","19111","28078","21832","12985","16846","13857","14600","19116","17480","12986","16847","15962","15965","15967","15968","15969","15970","15972","15964","242519","230396","404549","15974","242517","230398","15977","230405","387510","330496","338374","15975","15976","242700","15978","15979","15980","13645","18590","18591","13649","18595","18596","16451","16452","16453","54721","20846","20847","20848","20849","20850","20851","20852","16391","12700","12703","216233","12702","67296","56468","192157","54607","12043","17210","12048","18712","17869","12443","12444","12445","12575","213043","11761","71872","71724","14580","20844","56324","19255","15170","12914","328572","56469","17344","229615","59004","14199","19247","14784","20662","20663","15461","110157","18706","18707","74769","18709","18708","18710","11651","11652","23797","56717")
m <- match(JAK_STAT_gene,anno_df$ENTREZID)
JAK_STAT_gene <- anno_df$SYMBOL[m]
JAK_STAT_gene <- JAK_STAT_gene[!is.na(JAK_STAT_gene)]
signal_gene_list[[11]] <- JAK_STAT_gene
names(signal_gene_list)[11] <- "JAK/STAT"

NF_kappaB_gene <- c("16818","22637","16797","18803","18761","20963","17096","17060","12229","234779","18751","105844","108723","170720","12042","240354","16176","16177","17874","16179","266632","22034","21926","21937","19766","71609","22030","22033","11797","11796","13607","13608","171211","74256","245527","230073","217069","16803","12475","21898","17087","117149","225471","106759","21947","21939","22031","21943","21934","16992","16994","50930","17000","53859","26409","66513","68652","66724","24099","72049","16151","12675","16150","11545","59004","22196","11920","57913","111173","18035","18033","19697","12633","11798","12048","12043","13197","17873","23882","22029","12047","12044","12045","12046","18034","21929","19225","20303","14825","20310","330122","22329","18792","12995","13000","13001","19698","24047","100862177","100504346","100504239","100042493","18829","20315","15894")
m <- match(NF_kappaB_gene,anno_df$ENTREZID)
NF_kappaB_gene <- anno_df$SYMBOL[m]
NF_kappaB_gene <- NF_kappaB_gene[!is.na(NF_kappaB_gene)]
signal_gene_list[[12]] <- NF_kappaB_gene
names(signal_gene_list)[12] <- "NF_kappaB"

TNF_gene <- c("21926","21937","67384","71609","22030","22033","19766","11797","11796","26409","66513","68652","66724","26398","26400","26419","26420","26414","16476","14281","16396","12633","26397","26399","26416","19094","29857","26415","12608","26408","53859","16151","16150","12675","18035","19697","18033","26410","26395","26413","26417","73086","56613","12912","12913","26427","208647","208677","78284","11909","11911","231991","12915","56532","14082","12370","12369","12367","74568","72542","74006","74256","11798","20296","20293","20304","20297","14825","20310","330122","20311","15945","20312","12977","12981","14102","16182","16449","16176","16193","16168","16878","16992","12051","12702","21929","22029","15953","432555","16477","17392","17395","17387","13614","22341","14205","257632","15894","20339","22329","19225","21938","22031","18706","18707","74769","18709","18708","18710","11651","11652","23797","69601","16362","15977")
m <- match(TNF_gene,anno_df$ENTREZID)
TNF_gene <- anno_df$SYMBOL[m]
TNF_gene <- TNF_gene[!is.na(TNF_gene)]
signal_gene_list[[13]] <- TNF_gene
names(signal_gene_list)[13] <- "TNF"

HIF1_gene <- c("16193","16194","20848","21898","15978","15979","15980","19697","18033","16334","16333","13645","16000","16337","13649","16001","13866","26395","26396","26413","26417","17346","17347","18706","18707","74769","18709","18708","18710","11651","11652","23797","56717","13685","13684","26987","218268","58988","72508","20104","15251","22346","56438","67923","67673","71745","112407","112406","112405","11863","12914","328572","13058","18803","234779","18750","18751","18752","108058","12325","12323","12322","21857","17000","13856","22041","71775","22042","22339","14254","18787","11600","11601","11602","21687","13614","18126","18127","15368","230899","20525","228026","15277","212032","15275","216019","18641","18642","56421","14433","115487111","11674","230163","11676","353204","79459","13806","13807","13808","433182","226265","18655","18663","170768","16828","16832","16833","106557","12043","12575","12576","18597","18598","68263")
m <- match(HIF1_gene,anno_df$ENTREZID)
HIF1_gene <- anno_df$SYMBOL[m]
HIF1_gene <- HIF1_gene[!is.na(HIF1_gene)]
signal_gene_list[[14]] <- HIF1_gene
names(signal_gene_list)[14] <- "HIF1"

Calcium_gene <- c("20541","110891","110893","67972","320707","381290","11941","12669","12671","213788","11540","11541","11554","11555","11556","13488","13492","15466","15562","15563","15564","15565","15566","14683","14680","432530","210044","104111","104110","11513","11514","11515","18747","18749","18821","66402","69563","67704","68528","11937","53313","11938","15464","20866","116873","109305","269717","269999","12288","12289","54652","12292","12286","12287","12290","12291","58226","239556","11441","14810","14811","14812","14813","14814","242443","170483","18436","231602","228139","18438","94045","18440","18439","20190","20191","20192","76757","12372","12373","65973","58861","70086","243764","11549","11548","11550","11607","11608","13617","13618","14062","14816","108071","14829","15465","15558","15559","15560","16867","18216","18430","54140","26361","57260","19204","19216","19218","19220","12061","12062","21336","21337","21338","21390","22045","170732","12425","12426","12767","14682","14672","14675","14676","13645","21802","18590","18591","54635","71785","14164","14173","14174","14175","14176","14178","14179","14180","14165","80903","14171","14172","80857","67112","14177","14170","56636","64654","22339","22340","22341","14205","18048","18049","15234","15235","14573","13649","13866","13867","13869","18595","18596","14182","14183","14184","14186","14254","14257","16542","18211","18212","18213","17295","19882","19713","18799","72469","18802","18795","18797","18798","18796","18803","234779","74055","114875","16438","16439","16440","12494","252972","233979","94178","68279","171166","56632","20698","215999","22333","22334","22335","11739","11740","73333","105675","21924","21925","12313","80796","12315","12314","70405","494124","75600","18682","68961","110094","18679","102093","107589","213435","228785","238564","215303","52163","108058","12325","12323","12322","12326","19057","19055","19056","19058","19059","21425","18018","18019","18021","73181","18125","18126","18127","18573","18574","18575","19229","320404","228550","233011","18750","18751","18752")
m <- match(Calcium_gene,anno_df$ENTREZID)
Calcium_gene <- anno_df$SYMBOL[m]
Calcium_gene <- Calcium_gene[!is.na(Calcium_gene)]
signal_gene_list[[15]] <- Calcium_gene
names(signal_gene_list)[15] <- "Calcium"

mTOR_gene <- c("20539","17254","268706","11964","11966","110935","66335","68775","73834","11973","74915","66144","66237","66290","338375","108664","66508","83409","56692","66096","68576","216805","216742","329679","68441","245670","52187","54170","230784","71962","80909","252875","72124","268933","319481","110379","277854","56032","17168","27401","320311","74370","67605","56717","97998","56716","71718","75425","56430","14783","14245","64899","64898","22241","29869","13685","13684","26987","218268","58988","72508","75705","20104","72149","227154","20869","12283","69008","105787","108079","64930","22084","67046","19744","74747","22408","22413","22414","22415","22416","22417","22418","22419","22420","22421","22422","20890","22423","216795","22412","22410","22409","22411","93735","14362","14369","57265","14365","14366","14367","14370","14368","93897","14371","16973","16974","13544","13542","13543","56637","21926","21937","16150","16334","16333","16000","16337","16001","14784","20662","20663","15461","16653","18176","109880","110157","26395","26396","26413","26417","110651","20111","20112","67071","16367","18709","18708","18710","18706","18707","74769","19211","18607","11651","11652","23797","12675","227743","78757","109270","72446","11848","67653","18750","18751","18752","20393")
m <- match(mTOR_gene,anno_df$ENTREZID)
mTOR_gene <- anno_df$SYMBOL[m]
mTOR_gene <- mTOR_gene[!is.na(mTOR_gene)]
signal_gene_list[[16]] <- mTOR_gene
names(signal_gene_list)[16] <- "mTOR"

hep_score <- hep

hep_score <- AddModuleScore(hep_score,
                            features = signal_gene_list,
                            name = names(signal_gene_list))

colnames(hep_score@meta.data)[12:27] <- names(signal_gene_list)
score_df <- data.frame(cls=0:13)


for (i in 1:length(signal_gene_list)) {
  col_name <- colnames(hep_score@meta.data)[i+11]
  score_df[,i+1] <- as.data.frame(hep_score@meta.data %>% group_by(seurat_clusters) %>%                          summarise(a=mean(!!as.name(col_name))))[2]
}
rownames(score_df) <- score_df$cls
score_df$cls <- NULL

colnames(score_df) <- names(signal_gene_list)

score_df <- t(as.matrix(score_df))
Heatmap(score_df,column_title = "Raw gene score")

score_df_scale <- t(scale(t(score_df)))

p <- ComplexHeatmap::Heatmap(score_df_scale,row_names_gp = gpar(fontsize=6),
                             column_dend_height = unit(0.3,"cm"),
                             row_dend_width = unit(0.3,"cm"),
                             column_names_gp = gpar(fontsize=8),
                             heatmap_legend_param =list(title="Scale",
                                                        grid_width=unit(0.2,"cm"),
                                                        title_gp=gpar(fontsize=6),
                                                        labels_gp=gpar(fontsize=6)),
                             width = unit(3,"cm"))

p


# Fig.2F
p1 <- RidgePlot(hep,"Alb")+NoLegend()
p2 <- RidgePlot(hep,"Trf")+NoLegend()
p1+p2


# Fig.S2A
remove(list = ls()[!(ls() %in% c("anno_df","hep","all_gene"))])
deg_cls7 <- FindMarkers(hep,ident.1 = 7,logfc.threshold = 0.25,min.pct = 0.1)
deg_cls7 <- deg_cls7[deg_cls7$p_val_adj<1,]
deg_cls7 <- deg_cls7[order(deg_cls7$avg_log2FC,decreasing = T),]

m <- match(rownames(deg_cls7),anno_df$SYMBOL)
deg_cls7$Entrez <- anno_df$ENTREZID[m]
all_gene_id <- unique(anno_df$ENTREZID)
all_gene_id <- all_gene_id[!is.na(all_gene_id)]
gene_up <- deg_cls7$Entrez[deg_cls7$avg_log2FC>0]
gene_down <- deg_cls7$Entrez[deg_cls7$avg_log2FC<0]

go_7_up_bp <- enrichGO(gene = gene_up,OrgDb = org.Mm.eg.db,keyType = "ENTREZID",ont = "BP",universe = all_gene_id,readable = TRUE)
go_7_up_bp_simple <- clusterProfiler::simplify(go_7_up_bp)
p_go7_bp_simple <- dotplot(go_7_up_bp_simple,font.size=8)
p_go7_bp_simple


# Fig.S2B
gene_7 <- rownames(deg_cls7)[1:20]
gene_7 <- gene_7[!(gene_7 %in% c("Gm26917","Ac149090.1"))]
p1 <- DotPlot(hep,features = gene_7[1:10])+ggtitle("Cluster 7 feature gene")+
  theme(axis.text.x = element_text(angle = 90,vjust = 0.5))
p1


# Fig.S2C
p1 <- VlnPlot(hep,features = "Saa1",idents = c(7,13),pt.size = 0)+NoLegend()
p2 <- VlnPlot(hep,features = "Hp",idents = c(7,13),pt.size = 0)+NoLegend()
p3 <- VlnPlot(hep,features = "Fga",idents = c(7,13),pt.size = 0)+NoLegend()

p4 <- VlnPlot(hep,features = "Glul",idents = c(7,13),pt.size = 0)+NoLegend()
p5 <- VlnPlot(hep,features = "Cyp2e1",idents = c(7,13),pt.size = 0)+NoLegend()
p6 <- VlnPlot(hep,features = "Cyp7a1",idents = c(7,13),pt.size = 0)+NoLegend()
p1+p2+p3
p4+p5+p6


# Fig.S2D
remove(list = ls()[!(ls() %in% c("anno_df","hep","all_gene"))])
p1 <- FeaturePlot(hep,"Mki67",order = TRUE)
p1


# Fig.S2E
remove(list = ls()[!(ls() %in% c("anno_df","hep","all_gene"))])
p1 <- VlnPlot(hep,"Tmsb4x")+NoLegend()
p2 <- VlnPlot(hep,"Sparc")+NoLegend()

# Fig.S2_cluster0/1/8 mitochondoria gene vlnplot
p1 <- VlnPlot(hep,features = "percent_mt",pt.size = 0,idents = c(0,1,8))+NoLegend()+
  ggtitle("Mitochondrial genes")+
  ylab("Percentage(%)")
p1











